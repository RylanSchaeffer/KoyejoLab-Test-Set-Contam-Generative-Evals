# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

Research project investigating how test set contamination (data leakage) affects generative model evaluations on math problem-solving benchmarks. The project studies whether generative evaluations respond differently to contamination compared to discriminative evaluations, using controlled contamination experiments with Qwen3 models.

## Environment Setup

```bash
# Install uv package manager
conda install conda-forge::uv

# Create virtual environment
uv venv -p 3.11.5 mem_scoring_vs_sampling_env
source mem_scoring_vs_sampling_env/bin/activate

# Install dependencies
uv pip install -r requirements.txt

# Install EleutherAI LM Evaluation Harness (required for math-verify)
git clone --depth 1 https://github.com/EleutherAI/lm-evaluation-harness
cd lm-evaluation-harness
uv pip install -e .[math]
uv pip install flash-attn==2.7.2.post1 --no-build-isolation
```

## Common Commands

```bash
# Run pretraining with contaminated corpus
python scripts/pretrain_language_model.py

# Multi-GPU pretraining
torchrun --standalone --nproc_per_node=1 scripts/pretrain_language_model.py

# Supervised fine-tuning
python scripts/sft_language_model.py

# Model evaluation (uses vLLM for inference)
python scripts/eval_language_model.py

# Teacher-forced evaluation (log probabilities of ground-truth solutions)
python scripts/eval_language_model_teacher_forcing.py

# Run W&B sweep
wandb sweep sweeps/pt/math_82gb_1xOT/model=qwen3-34M-1xOT.yaml
wandb agent [agent-id]

# Format code
black .
```

## Architecture

### Core Modules (`src/`)

- **globals.py**: Default configurations for pretraining, SFT, and evaluation. Contains `DEFAULT_PRETRAINING_CONFIG`, `DEFAULT_SUPERVISED_FINETUNING_CONFIG`, `DEFAULT_EVALUATION_CONFIG`, `DEFAULT_TEACHER_FORCING_EVALUATION_CONFIG`. Key contamination parameters: `benchmark_subset_fraction`, `num_benchmark_replicas_per_epoch`.

- **models.py**: Model loading and creation. `create_causalm_for_pretraining()` creates Qwen3 models from scratch; `load_automodelforcausallm()` loads from HF Hub. Supports Qwen3 models from 34M to 1.44B parameters.

- **data.py**: Dataset loading and preprocessing. `create_dataset_for_pretraining()` creates contaminated pretraining datasets by replicating MATH test set N times into fineweb-edu-dedup corpus. `create_dataset_for_supervised_finetuning()` handles MATH/GSM8K data.

- **analyze.py**: Analysis utilities for extracting metrics from W&B runs into pandas DataFrames.

- **plot.py**: Publication-quality matplotlib/seaborn visualizations.

- **neural_scaling_laws.py**: `PowerLawScalingFitter` class for fitting neural scaling laws. Fits: L(C,R) = E(R) + C_0(R) * C^(-α(R)).

### Training Scripts (`scripts/`)

- **pretrain_language_model.py**: Main pretraining with HF Trainer, DDP, W&B integration. Model naming convention: `mem_[modelname]_[benchmark]_rep_[replicas]_sbst_[subset]_epch_[epochs]_ot_[overtrain]`. Auto-uploads to HF Hub.

- **sft_language_model.py**: SFT using TRL's SFTTrainer. Can train on train or test split.

- **eval_language_model.py**: Evaluation using vLLM for inference and math-verify for scoring. Supports greedy decoding and sampling.

- **eval_language_model_teacher_forcing.py**: Teacher-forced evaluation that computes log probabilities of ground-truth solutions without sampling. Useful for measuring memorization since memorized solutions will have higher log probabilities.

### Experiment Sweeps (`sweeps/`)

W&B sweep configurations organized by experiment type:
- `pt/`: Pretraining sweeps (grid searches over contamination levels, model sizes)
- `sft/`: SFT sweeps
- `eval_pt/`, `eval_sft/`: Generative evaluation sweeps (sampling-based)
- `eval_pt_teacher_forcing/`: Teacher-forced evaluation sweeps (log probability-based)
- `dose_response/`: Dose response studies

### Analysis Notebooks (`notebooks/`)

Key notebook series:
- `10_*`, `11_*`: Pretraining cross-entropy and math verify results
- `12_*`, `13_*`: SFT cross-entropy and math verify results
- `20_*`: Contamination vs compute scaling analysis
- `30_*`: Dose response curves

### Manuscript (`manuscript/`)

LaTeX source for ICML paper. Main file is `00_main.tex`. Figures generated by notebooks go in `figures/`.

## Key Concepts

**Contamination Control**: The codebase controls contamination by injecting N replicas of the MATH test set into the pretraining corpus. Key parameters in `globals.py`:
- `num_benchmark_replicas_per_epoch`: Number of times test set is repeated
- `benchmark_subset_fraction`: Fraction of benchmark to use

**Model Naming**: Pretrained models follow the pattern `mem_[model]_[benchmark]_rep_[replicas]_sbst_[subset]_epch_[epochs]_ot_[overtrain]` for tracking contamination levels.

**Math Verify**: The project includes a fix for a critical bug in EleutherAI's math-verify implementation. The evaluation script uses a corrected version.

## Visual Aesthetic

All plots must follow these conventions (defined in `src/plot.py`):

**Global settings** (automatically applied via `import src.plot`):
- Style: `sns.set_style("whitegrid")`
- LaTeX rendering enabled with Computer Modern serif font
- Font size: 23
- Grid alpha: 0.5, showing both major and minor gridlines
- Default figure size: `src.plot.default_figsize` (10.67 × 8 inches)

**Plot construction pattern**:
```python
plt.close()
plt.figure(figsize=src.plot.default_figsize)
g = sns.lineplot(...)  # or sns.scatterplot
g.set(xlabel=..., ylabel=...)
src.plot.save_plot_with_multiple_extensions(plot_dir=results_dir, plot_filename="y=response_x=predictor_hue=variable")
# plt.show()  # DO NOT call plt.show() - it blocks execution and annoys the user
```

**Guidelines**:
- **NEVER call `plt.show()`** - it blocks script execution and opens interactive windows. Always comment it out or omit it entirely. Plots are saved to files via `save_plot_with_multiple_extensions()`.
- No figure titles or axes titles (column/row titles in faceted plots are acceptable)
- Choose axis scales thoughtfully: use log/symlog when data spans orders of magnitude, linear otherwise
- Axis labels should use LaTeX math mode where appropriate
- Use `LogNorm()` for hue variables that span orders of magnitude (e.g., model size, FLOP)
- Format large numbers in legends with `format_g_legend_to_millions_and_billions()` or `format_g_legend_in_scientific_notation()`
- Filename convention: `y=<response>_x=<predictor>_hue=<grouping>`
- Save via `save_plot_with_multiple_extensions()` (outputs PDF and PNG at 300 DPI)

## W&B Integration

All experiments log to Weights & Biases. Ensure `WANDB_API_KEY` is set. Sweep configs in `sweeps/` define hyperparameter grids for systematic experiments.

## HuggingFace Hub

Trained models are automatically uploaded to HF Hub at the end of training. Requires `HF_TOKEN` environment variable.
